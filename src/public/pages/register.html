<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../disegn/example.css">
  <title>Registro / Login - Nexus Battles IV</title>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 id="formTitle">Registro de Usuario</h1>
  
  <form id="userForm">
    <!-- Campos de registro -->
    <div id="extraFields">
      <input type="text" name="nombres" placeholder="Nombres" /><br>
      <input type="text" name="apellidos" placeholder="Apellidos" /><br>
      <input type="text" name="apodo" placeholder="Apodo" /><br>
      <input type="text" name="avatar" placeholder="Avatar (URL)" /><br>
    </div>

    <!-- Campos comunes -->
    <input type="email" name="email" placeholder="Correo electr√≥nico" required /><br>
    <input type="password" name="password" placeholder="Contrase√±a" required /><br>

    <!-- Confirmar contrase√±a solo en registro -->
    <div id="confirmField">
      <input type="password" name="confirmPassword" placeholder="Confirmar contrase√±a" />
    </div><br>

    <button type="submit" id="submitBtn">Registrarse</button>
  </form>

  <!-- Bot√≥n para alternar -->
  <button id="toggleMode">¬øYa tienes cuenta? Inicia sesi√≥n</button>

  <script>
    let isRegister = true; // Estado inicial: Registro

    const form = document.getElementById("userForm");
    const toggleBtn = document.getElementById("toggleMode");
    const formTitle = document.getElementById("formTitle");
    const submitBtn = document.getElementById("submitBtn");
    const extraFields = document.getElementById("extraFields");
    const confirmField = document.getElementById("confirmField");

    // Alternar entre registro y login
    toggleBtn.addEventListener("click", () => {
      isRegister = !isRegister;
      if (isRegister) {
        formTitle.textContent = "Registro de Usuario";
        submitBtn.textContent = "Registrarse";
        toggleBtn.textContent = "¬øYa tienes cuenta? Inicia sesi√≥n";
        extraFields.classList.remove("hidden");
        confirmField.classList.remove("hidden");
      } else {
        formTitle.textContent = "Iniciar Sesi√≥n";
        submitBtn.textContent = "Entrar";
        toggleBtn.textContent = "¬øNo tienes cuenta? Reg√≠strate";
        extraFields.classList.add("hidden");
        confirmField.classList.add("hidden");
      }
    });

    // Manejo de submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        email: e.target.email.value.trim().toLowerCase(),
        password: e.target.password.value,
      };

      if (isRegister) {
        data.nombres = e.target.nombres.value.trim();
        data.apellidos = e.target.apellidos.value.trim();
        data.apodo = e.target.apodo.value.trim();
        data.avatar = e.target.avatar.value;
        data.confirmPassword = e.target.confirmPassword.value;

        if (data.password !== data.confirmPassword) {
          alert("‚ö†Ô∏è Las contrase√±as no coinciden.");
          return;
        }
      }

      const endpoint = isRegister
        ? "http://localhost:3000/api/usuarios/register"
        : "http://localhost:3000/api/usuarios/login";

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const result = await res.json();
      console.log(result);

      if (res.ok) {
        alert(isRegister ? "Usuario registrado exitosamente ‚úÖ" : "Login exitoso üéâ");
        if (!isRegister && result.token) {
          localStorage.setItem("token", result.token);
          localStorage.setItem("rol", result.rol);

          if (result.rol === "admin") {
            window.location.href = "/pages/adminPanel.html"; // tu panel de admin
          } else {
            window.location.href = "/pages/HomeUser.html"; // men√∫ usuario
          }
        }
      } else {
        alert(result.message || "‚ùå Ocurri√≥ un error");
      }
    });
  </script>
</body>
</html>
